name: Transcribe Batch Audio Files (From ZIP)

on:
  workflow_dispatch:
    inputs:
      whisper_model:
        description: 'Chá»n model Whisper (tiny, small, medium, large)'
        required: true
        default: 'tiny'

jobs:
  batch-transcribe:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout source code & audio zip
        uses: actions/checkout@v3

      - name: ğŸ“‚ Giáº£i nÃ©n file audio zip
        run: |
          mkdir -p audio
          unzip -o audio-uploads/audio-files.zip -d audio
          echo "âœ… Danh sÃ¡ch file .mp3:"
          ls -1 audio/*.mp3

      - name: ğŸ› ï¸ Build Docker image tá»« Dockerfile trong repo
        run: |
          echo "ğŸ› ï¸ Building Docker image 'whisper-local'..."
          docker build -t whisper-local .

      - name: ğŸ§ Cháº¡y Whisper trÃªn táº¥t cáº£ file .mp3 (trong 1 láº§n docker run)
        run: |
          echo "ğŸ¯ Using Whisper model: ${{ github.event.inputs.whisper_model }}"
          docker run --rm \
            -v ${{ github.workspace }}/audio:/workspace \
            whisper-local \
            bash -c '
              for f in /workspace/*.mp3; do
                echo "ğŸ” Transcribing: $f"
                whisper "$f" \
                  --language en \
                  --model ${{ github.event.inputs.whisper_model }} \
                  --output_format srt \
                  --word_timestamps True \
                  --max_words_per_line 1 \
                  --output_dir /workspace
              done
            '
          echo "âœ… Whisper hoÃ n táº¥t cho toÃ n bá»™ file."

      - name: â¬†ï¸ Upload táº¥t cáº£ file SRT
        uses: actions/upload-artifact@v4
        with:
          name: all-srt-files
          path: audio/*.srt
