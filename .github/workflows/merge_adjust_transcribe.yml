name: Merge, Adjust Speed, and Transcribe MP3

on:
  workflow_dispatch:
    inputs:
      whisper_model:
        description: 'Model Whisper (tiny, small, medium, large)'
        required: true
        default: 'tiny'
      speed:
        description: 'Tá»‘c Ä‘á»™ Ä‘iá»u chá»‰nh audio (vÃ­ dá»¥: 0.8, 1.0, 1.2)'
        required: true
        default: '1.0'

jobs:
  merge-adjust-transcribe:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout source code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ CÃ i Ä‘áº·t ffmpeg vÃ  whisper
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install --upgrade pip
          pip install setuptools-rust
          pip install openai-whisper

      - name: ðŸ“‚ Giáº£i nÃ©n file audio zip
        run: |
          mkdir -p audio
          unzip -o audio-uploads/audio-files.zip -d audio
          echo "âœ… Danh sÃ¡ch file:"
          ls -1 audio/*.mp3

      - name: ðŸ”— Ná»‘i táº¥t cáº£ file .mp3 theo thá»© tá»± tÃªn tÄƒng dáº§n
        run: |
          mkdir -p merged
          ls audio/*.mp3 | sort -V > merged/sorted.txt
          while read f; do
            echo "file '$PWD/$f'" >> merged/list.txt
          done < merged/sorted.txt
          echo "ðŸ“ƒ Danh sÃ¡ch merge:"
          cat merged/list.txt
          ffmpeg -f concat -safe 0 -i merged/list.txt -c copy merged/merged.mp3

      - name: "ðŸ¢ Äiá»u chá»‰nh tá»‘c Ä‘á»™ audio (speed: ${{ github.event.inputs.speed }})"
        run: |
          mkdir -p adjusted
          ffmpeg -i merged/merged.mp3 -filter:a "atempo=${{ github.event.inputs.speed }}" -vn adjusted/adjusted.mp3

      - name: âœï¸ Chuyá»ƒn thÃ nh phá»¥ Ä‘á» SRT báº±ng Whisper
        run: |
          echo "ðŸ§  Whisper model: ${{ github.event.inputs.whisper_model }}"
          echo "ðŸ¢ Audio speed: ${{ github.event.inputs.speed }}"
          whisper adjusted/adjusted.mp3 \
            --language en \
            --model ${{ github.event.inputs.whisper_model }} \
            --output_format srt \
            --word_timestamps True \
            --max_words_per_line 1 \
            --output_dir output
      - name: ðŸ·ï¸ Äá»•i tÃªn file káº¿t quáº£
        run: |
          cp adjusted/adjusted.mp3 audio_adjusted_${{ github.event.inputs.speed }}x.mp3
          cp output/adjusted.srt transcript_${{ github.event.inputs.whisper_model }}.srt

      - name: â¬†ï¸ Upload file káº¿t quáº£ (.mp3 vÃ  .srt) cÃ³ tÃªn theo model vÃ  speed
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.whisper_model }}_${{ github.event.inputs.speed }}x_output
          path: |
            audio_adjusted_${{ github.event.inputs.speed }}x.mp3
            transcript_${{ github.event.inputs.whisper_model }}.srt
